<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{ret-layout}">

<body onload="javascript:var bread = [['Home', '/retail/dashboard'],['Account Statement']];currentBar('Account Statement');breadCrumb(bread)">

<div layout:fragment="content">
    <div class="col-md-5 col-sm-5 ">

        <select class="form-control full-width coronation-form-control hide-content-only" id="view">
            <option value="account">Overview</option>
        </select>
    </div>

    <div class="col-xs-12 " >
        <div class="no-pad-left no-mt  alert no-bd">
           <form method="post" th:action="@{/retail/account/viewstatement/display}">

               <div class="col-md">
                   <br/>
                   <div class="form-group col-md-12 col-sm-12">
                       <div class="form-group col-md-6 col-sm-6">
                           <label>Date Range</label>
                           <div class="input-daterange input-group" id="date-range">
                               <input type="text" data-date-format="dd-mm-yyyy" class="form-control datepicker" id="start" name="fromDate" placeholder="Start date" required="required" />
                               <span class="input-group-addon no-border">to</span>
                               <input type="text"  data-date-format="dd-mm-yyyy" class="form-control datepicker" name="toDate" id="endDate" placeholder="End date" required="required" />
                           </div>
                       </div>
                       <div class="form-group col-md-6 col-sm-6">
                           <label>Transaction Type</label>
                           <select name="tranType"  class="form-control">
                               <option value="B">All</option>
                               <option value="C">Credit</option>
                               <option value="D">Debit</option>
                           </select>
                       </div>
                   </div>
                   <div class="form-group col-md-12 col-sm-12">
                       <div class="form-group col-md-6 col-sm-6">
                           <label>Account Number</label>
                           <span class="req"></span>
                           <select name="acctNumber" id="acctNumber" class="form-control"
                                   required="required">
                               <option th:each="s: ${accounts}" th:value="${s.accountNumber}" th:text="${s.accountNumber}"></option></select>
                       </div>

                       <div class="form-group col-md-6">
                           <label>&nbsp;</label>
                           <button type="submit" class="btn btn-link " id="btn-find"><i class="fa fa-search" style="color: white" ></i>&nbsp; view</button>
                       </div>
                   </div>



                   <p>
                       <a id="btn-print" th:href="@{'~/viewstatement/display/data'}"  class="btn bt-link-act pull-right"> <i class="fa fa-print"  ></i>&nbsp; Download</a>
                       <!--<a th:href="@{'#'}" class="btn "> <i class="fa fa-envelope" style="color: white" ></i>&nbsp; send mail</a>-->
                   </p>

                   <h2>TRANSACTION DETAILS</h2>

                   <div class="" >
                       <table class="table" id="tranDetails">
                           <thead>
                           <tr>
                               <th>Transaction Narration</th>
                               <th>Post Date</th>
                               <th>Value Date</th>
                               <th>Debit</th>
                               <th>Credit</th>
                               <th>Tran ID</th>
                               <th>Account Balance</th>
                           </tr>
                           </thead>
                           <tfoot>
                           <tr>
                               <th>Transaction Narration</th>
                               <th>Post Date</th>
                               <th>Value Date</th>
                               <th>Debit</th>
                               <th>Credit</th>
                               <th>Tran ID</th>
                               <th>Account Balance</th>

                           </tr>
                           </tfoot>
                       </table>
                       <div class="col-md-12">
                           <div class="pull-right">
                           <button class="btn btn-md" id="previous" type="button" onclick="previousData()">previous</button>&nbsp;<button class="btn btn-md" type="button" id="next"  onclick="nextData()">next</button>
                           </div>
                       </div>
                       <!--<div> <button class="btn-primary" type="button" id="previous" onclick="previousData()">previous</button>&nbsp;<button class="btn-primary" type="button" id="next" onclick="nextData()">next</button></div>-->
                   </div>


               </div>
                </form>
        </div>
    </div>

</div>


<th:block layout:fragment="scripts">
    <script th:inline="javascript">
    /*<![CDATA[*/
    jQuery.download = function(url, key, data) {
        // Build a form
        var form = $('<form></form>').attr('action', url).attr('target', '_blank')
                .attr('method', 'get');
        // Add the one key/value
        form.append($("<input/>").attr('type', 'hidden').attr('name',
                key).attr('value', data));

        $.each( data, function( propertyName, valueOfProperty ){
            form.append($("<input/>").attr('type', 'hidden').attr('name',
                    propertyName).attr('value', valueOfProperty));
        });

        //send request
        form.appendTo('body').submit().remove();
    };
    $(document).ready(function() {
        $('#btn-print').hide();
        $('#tranDetails_length').hide();
        $('#tranDetails_paginate').hide();
//        $('.datepicker').datepicker({ dateFormat: 'dd-mm-yy' });//
//        $('#start').datepicker({
//            onSelect: function(dateText, inst) {
//                //Get today's date at midnight
//                var today = new Date();
//                today = Date.parse(today.getMonth()+1+'/'+today.getDate()+'/'+today.getFullYear());
//                //Get the selected date (also at midnight)
//                var selDate = Date.parse(dateText);
//
//                if(selDate < today) {
//                    console.log("hshs");
//                    //If the selected date was before today, continue to show the datepicker
//                    $('#start').val('');
//                    $(inst).datepicker('show');
//                }
//            }
//        });

//        $('#tranDetails').DataTable({
//            responsive: true,
//
//            "lengthMenu" : [ [ 5, 10, 20],	[ 5, 10, 20 ] ],
//            "pagingType" : "simple_numbers",
//            "searching": false,
//            "paging": true,
//            "processing": false,
//            "serverSide" : false,
//            "ordering" : false,
//            "dom": 'T<"clear">frtlp',
//            "columns" : [
//                {"data" : "postDate"} ,
//                {"data" : "valueDate"},
//                {"data" : "narration"},
//                {"data" : "tranType"},
//                {"data" : "tranId"},
//                {"data" : "accountBalance"}
//            ],
//            "columnDefs" : [ {
//                "targets" : 3,
//                "data" : "tranType",
//                "render" : function(data, type,full, meta) {
//                    if (type === 'display') {
//                        if(data == null) return data;
//
//                       var spacedData = '         '+data;
//                        return spacedData;
//                    }
//                    return data;
//                }
//            }, {
//                "targets" : 0,
//                "data" : "postDate",
//                "render" : function(data, type,full, meta) {
//                    if (type === 'display') {
//                        if(data == null)
//                            return data;
//
//                        var pattern = /(\d{2})\.(\d{2})\.(\d{4})/;
//                        var dt = new Date(data.replace(pattern,'$3-$2-$1'));
//                        return dt.toDateString();
//                    }
//                    return data;
//                }
//            },{
//                "targets" : 5,
//                "data" : "accountBalance",
//                "render" : function(data, type,full, meta) {
//                    if (type === 'display') {
//                        if(data == null)
//                            return data;
//                        var twoPlacedFloat = parseFloat(data).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
//                        return twoPlacedFloat;
//                    }
//                    return data;
//                }
//            }
//                , {
//                    "targets": 1,
//                    "data": "valueDate",
//                    "render": function (data, type, full, meta) {
//                        if (type === 'display') {
//
//                            if (data == null)
//                                return data;
//                            var pattern = /(\d{2})\.(\d{2})\.(\d{4})/;
//                            var dt = new Date(data.replace(pattern,'$3-$2-$1'));
//                            return dt.toDateString();
//                        }
//                        return data;
//                    }
//                } ],
//            "ajax" : {
//                "url":"viewstatement/display/data",
//                "type" : "GET",
//                "data" : function(d) {
//                    d.acctNumber = $('[name=acctNumber]').val();
//                    d.fromDate = $('[name=fromDate]').val();
//                    d.toDate = $('[name=toDate]').val();
//                    d.tranType = $('[name=tranType]').val();
//                }
//            }
//
//        });
            $('#tranDetails').DataTable({
            responsive: true,

//            "lengthMenu" : [ [ 5, 10, 20],	[ 5, 10, 20 ] ],
            "pagingType" : "simple_numbers",
            "searching": false,
            "paging": true,
            "processing": false,
            "serverSide" : false,
            "ordering" : false,
            "dom": 'T<"clear">frtlp',
            "columns" : [
                {"data" : "narration"},
                {"data" : "postDate"} ,
                {"data" : "valueDate"},
                {"data" : "debitAmount"},
                {"data" : "creditAmount"},
                {"data" : "tranId"},
                {"data" : "accountBalance"}
            ],
            "columnDefs" : [
//                {
//                "targets" : 3,
//                "data" : "tranType",
//                "render" : function(data, type,full, meta) {
//                    if (type === 'display') {
//                        if(data == null) return data;
//
//                       var spacedData = '         '+data;
//                        return spacedData;
//                    }
//                    return data;
//                }
//            },
                {
                "targets" : 1,
                "data" : "postDate",
                "render" : function(data, type,full, meta) {
                    if (type === 'display') {
                        if(data == null)
                            return data;

                        var pattern = /(\d{2})\.(\d{2})\.(\d{4})/;
                        var dt = new Date(data.replace(pattern,'$3-$2-$1'));
                        return dt.toDateString();
                    }
                    return data;
                }
            },{
                "targets" : 6,
                "data" : "accountBalance",
                "render" : function(data, type,full, meta) {
                    if (type === 'display') {
                        if(data == null)
                            return data;
                        var twoPlacedFloat = parseFloat(data).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
                        return twoPlacedFloat;
                    }
                    return data;
                }
            }
                , {
                    "targets": 2,
                    "data": "valueDate",
                    "render": function (data, type, full, meta) {
                        if (type === 'display') {

                            if (data == null)
                                return data;
                            var pattern = /(\d{2})\.(\d{2})\.(\d{4})/;
                            var dt = new Date(data.replace(pattern,'$3-$2-$1'));
                            return dt.toDateString();
                        }
                        return data;
                    }
                } ],

        });
//        var table = $('#tranDetails').DataTable({
//            drawCallback: function(){
//                $('.paginate_button.next', this.api().table().container())
//                        .on('click', function(){
//                            alert('next');
//                        });
//            }
//        });
//        $("#btn-find").on("click", function(e) {
//
//            e.preventDefault();
//            dt = $('#tranDetails').DataTable();
//            $('#btn-print').show();
//            dt.ajax.reload(null, true);
//
//        });
//        $('#tranDetails_paginate').hide();
//        $('#tranDetails_length').hide();
        $("#btn-find").on("click", function(e) {
            var table = $('#tranDetails').DataTable();
            var row  = table.rows().remove().draw();
            e.preventDefault();
            $.ajax({ 
                "url":"viewstatement/display/data",
                "type" : "GET",
                "data" :  {
                    acctNumber : $('[name=acctNumber]').val(),
                    fromDate : $('[name=fromDate]').val(),
                    toDate : $('[name=toDate]').val(),
                    tranType : $('[name=tranType]').val()
                },success: function (result) {
//                    resetButton();
                    console.log("the output is "+result.details);
                    if (result.details != null && result.details != "null") {
                        $('#btn-print').show();
                        var contactsTab2 = $('#tranDetails').DataTable();
                        for (var key in result.details) {
                            if (result.details.hasOwnProperty(key)) {
                                var od = result.details[key];
//                                console.log("the key "+key+" value "+result[key]);
                                contactsTab2.row.add(od);
                            }

                            contactsTab2.draw();
//
                        }

                    }
                    if(result.moreData === "Y"){
                        $('#next').show();

                    }else{
                        $('#next').hide();
                    }
                    $('#previous').hide();

                },
                error:  function (dd) {
                    console.log("error")
                }
            
            });


        });
        $('#previous').hide();
        $('#next').hide();
        $('#tranDetails_length').hide();
        $('#tranDetails_paginate').hide();
        $("#btn-print").on("click", function(e) {
            e.preventDefault();

//            var table = $('#tranDetails').DataTable();
            var data = { "acctNumber" : $('[name=acctNumber]').val(),
                    "fromDate" : $('[name=fromDate]').val(),
                    "toDate" : $('[name=toDate]').val(),
                    "tranType" : $('[name=tranType]').val()} ;
            console.log("data "+data);
            $.download("downloadstatement", "data", data);

        });

        $('.dataTables_empty').html('No data available');

    });
function nextData() {
//    console.log("field value "+valu);
    $.ajax({
        "url":"viewstatement/display/data/next",
        "type" : "GET",
        "data" :  {
            acctNumber : $('[name=acctNumber]').val(),
            fromDate : $('[name=fromDate]').val(),
            toDate : $('[name=toDate]').val(),
            tranType : $('[name=tranType]').val(),
            state : "forward"
        },success: function (result) {
            if (result.details != null) {
//                resetButton();
//                        var detialsList = JSON.parse(result);
//                console.log("the result next"+result);
//                $('#tranDetails').DataTable().fnClearTable();
//                $('#tranDetails').dataTable().destroy();
//                $('#tranDetails tbody').empty();

                var contactsTab2 = $('#tranDetails').DataTable();
                var row  = contactsTab2.rows().remove().draw();
                for (var key in result.details) {
                            if (result.details.hasOwnProperty(key)) {
                                var od = result.details[key];
//                                console.log("the key "+key+" value "+result[key]);
                                contactsTab2.row.add(od);
                            }

                            contactsTab2.draw();
//
                }

            }
            if(result.moreData === "Y"){
                $('#next').show();

            }else{
                $('#next').hide();
            }
            $('#previous').show();
        },
        error:  function (dd) {
            console.log("error")
        }

    });
}
    function previousData() {
//    console.log("field value "+valu);
    $.ajax({
        "url":"viewstatement/display/data/back",
        "type" : "GET",
        "data" :  {
            state : "backward"
        },success: function (result) {
            if (result.details != null) {
//                resetButton();
//                        var detialsList = JSON.parse(result);
//                console.log("the result next"+result);
//                $('#tranDetails').DataTable().fnClearTable();
//                $('#tranDetails').dataTable().destroy();
                var contactsTab2 = $('#tranDetails').DataTable();
                var row  = contactsTab2.rows().remove().draw();
                                        for (var key in result.details) {
                            if (result.details.hasOwnProperty(key)) {
                                var od = result.details[key];
//                                console.log("the key "+key+" value "+result[key]);
                                contactsTab2.row.add(od);
                            }

                            contactsTab2.draw();
//
                        }

            }if(result.previousData === 0){
                $('#previous').hide();

            }else{
                $('#previous').show();
            }
            $('#next').show();
//            console.log("the result previous button "+result.previousData);


        },
        error:  function (dd) {
            console.log("error")
        }

    });
}


    /*]]>*/
</script>
<script>
    function getEmail()
    {
        $('#emailModal').modal({
            backdrop: 'static',
            keyboard: false,
            show: true

        })
    }

</script>
   
</th:block>




<div id="emailModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
<div class="modal-content no-bd-rad tokenBox" >
    <form id="loginform" th:action="@{/}" method="POST" >
        <div class="modal-body no-bd-rad">

            <div class="margin-bottom">
                <p style="margin-bottom:20px">Kindly enter email address</p>
                <div id="username_div" class="form-group">
                    <input  type="email" id="token" name="token" class='my-select tokenInput' placeholder="Email address" />
                </div>
                <div id='errorMess' class=" text-danger "></div>
                <div id='successMess' class=" text-success "></div>
            </div>


        </div>
        <div class="modal-footer no-bd-top ">
            <button  class="btn btn-link token-btn remove-item" data-dismiss="modal" >Back</button>

            <button type='submit' class="btn btn-link token-btn" >Continue</button>
        </div>

    </form>



</div>
    </div>

</body>
</html>